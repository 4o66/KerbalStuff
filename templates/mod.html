{% extends "layout.html" %}
{% block title %}
<title>{{ mod.name }} on Kerbal Stuff</title>
{% endblock %}
{% block styles %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='mod.css') }}" />
{% endblock %}
{% block scripts %}
<script src="/static/mods.js"></script>
{% endblock %}
{% block body %}
<script>
{% if editable %}
window.editable = true;
{% else %}
window.editable = false;
{% endif %}
window.download_stats = JSON.parse('{{ download_stats | tojson }}');
window.follower_stats = JSON.parse('{{ follower_stats | tojson }}');
window.referrals = JSON.parse('{{ referrals | tojson }}');
window.versions = JSON.parse('{{ json_versions | tojson }}');
window.thirty_days_ago = new Date({{ thirty_days_ago | tojson }});
</script>

<div class="header" style="background-image: url(https://cdn.mediacru.sh/{{ mod.background }});
    background-position: 0 {% if mod.bgOffsetY %}{{ mod.bgOffsetY }}px{% else %}0{% endif %};"></div>

<div class="container lead">
    <div class="row">
        <div class="col-md-8">
            <h1 title="{{ mod.name }}">{{ mod.name }}</h1>
        </div>
        <div class="{% if user %}col-md-2{% else %}col-md-4{% endif %}">
            <a  class="btn btn-block btn-lg btn-primary"
                href="/mod/{{ mod.id }}/{{ safe_name }}/download/{{ latest.friendly_version }}">
                Download</a>
        </div>
        {% if user %}
        <div class="col-md-2">
            <a  class="btn btn-block btn-lg btn-danger"
                href="/mod/{{ mod.id }}/{{ safe_name }}/download/{{ latest.friendly_version }}">
                Follow</a>
        </div>
        {% endif %}
    </div>
</div>

{# Note: this is a lot of markup for something fairly simple, I'd like to reduce it at some point #}
<div class="info-list">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <div class="timeline-centered">
                    
                    <div class="timeline-entry">
                        <div class="timeline-entry-inner">
                            <div class="timeline-icon">
                                <span class="glyphicon glyphicon-copyright-mark"></span>
                            </div>
                            <div class="timeline-label">
                                <h2 title="{{ mod.license }}">
                                    <span class="text-muted">
                                        License:
                                    </span>
                                    {{ mod.license }}
                                </h2>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-entry">
                        <div class="timeline-entry-inner">
                            <div class="timeline-icon">
                                <span class="glyphicon glyphicon-check"></span>
                            </div>
                            <div class="timeline-label">
                                <h2>
                                    <span class="text-muted">
                                        KSP Version:
                                    </span>
                                    {{ latest.ksp_version }}
                                </h2>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-entry">
                        <div class="timeline-entry-inner">
                            <div class="timeline-icon">
                                <span class="glyphicon glyphicon-download-alt"></span>
                            </div>
                            <div class="timeline-label">
                                <h2>
                                    <span class="text-muted">
                                        Downloads:
                                    </span>
                                    {{ mod.download_count }}
                                </h2>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <div class="col-md-6">
                <div class="timeline-centered">
                    
                    <div class="timeline-entry">
                        <div class="timeline-entry-inner">
                            <div class="timeline-icon">
                                <span class="glyphicon glyphicon-user"></span>
                            </div>
                            <div class="timeline-label">
                                <h2>
                                    <span class="text-muted">
                                        Author:
                                    </span>
                                    <a href="/profile/{{ mod.user.username }}">{{ mod.user.username }}</a>
                                </h2>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-entry">
                        <div class="timeline-entry-inner">
                            <div class="timeline-icon">
                                <span class="glyphicon glyphicon-globe"></span>
                            </div>
                            <div class="timeline-label">
                                <h2>
                                    <span class="text-muted">
                                        Mod Website:
                                    </span>
                                    <a href="{{ mod.external_link }}">{{ mod.external_link }}</a>
                                </h2>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-entry">
                        <div class="timeline-entry-inner">
                            <div class="timeline-icon">
                                <span class="glyphicon glyphicon-heart"></span>
                            </div>
                            <div class="timeline-label">
                                <h2>
                                    <span class="text-muted">
                                        Followers:
                                    </span>
                                    {{ mod.follower_count }}
                                </h2>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

<div class="tab-container">
    <div class="mod-tabs container">
        <a data-toggle="tab" href="#info" class="btn btn-primary">Information</a>
        <a data-toggle="tab" href="#changelog" class="btn btn-warning">Changelog</a>
        <a data-toggle="tab" href="#stats" class="btn btn-info">Stats</a>
    </div>
</div>

<div class="container">
    <div class="tab-content">
        <div class="tab-pane active" id="info">
            {{ mod.description | markdown }}
        </div>
        <div class="tab-pane" id="changelog">
            <div class="timeline-centered">
            {% for v in mod.versions %}
                <div class="timeline-entry">
                    <div class="timeline-entry-inner">
                        <div class="timeline-icon">
                            <span class="glyphicon glyphicon-asterisk"></span>
                        </div>
                        <div class="timeline-label">
                            <h2>Version {{ v.friendly_version }} <small>for Kerbal Space Program {{ v.ksp_version }}</small></h2>
                            <p><small class="text text-muted">Released on {{ v.created.strftime("%Y-%m-%d") }}</small></p>
                            {% if not v.changelog %}
                            <p><em>No changelog provided</em></p>
                            {% else %}
                            {{ v.changelog | markdown }}
                            {% endif %}
                            <p>
                                <a class="btn btn-primary" href="/mod/{{ mod.id }}/{{ safe_name }}/download/{{ v.friendly_version }}">
                                    <span class="glyphicon glyphicon-save"></span> Download
                                </a>
                                {% if editable %}
                                <button class="btn btn-danger edit-version" data-version="{{ v.id }}">
                                    <span class="glyphicon glyphicon-pencil"></span> Edit
                                </button>
                                <button class="btn btn-danger edit-version" data-version="{{ v.id }}">
                                    <span class="glyphicon glyphicon-trash"></span> Delete
                                </button>
                                <span class="hidden raw-changelog">{{ v.changelog }}</span>
                                {% if v.id != latest.id %}
                                <button class="set-default-version btn btn-danger">
                                    <span class="glyphicon glyphicon-ok"></span> Set as default
                                </button>
                                {% endif %}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            {% endfor %}
            </div>
        </div>
        <div class="tab-pane" id="stats">
            <h2>Stats for {{ mod.name }}</h2>
            <div class="row">
                <div class="col-md-8">
                    <h3>Downloads over time</h3>
                        <canvas id="downloads-over-time" class="canvas-chart" width=750 height=300></canvas>
                    <ul id="downloads-over-time-key" class="chart-key"></ul>
                    <h3>New followers per day</h3>
                        <canvas id="followers-over-time" class="canvas-chart" width=750 height=300></canvas>
                    </div>
                    <div class="col-md-4">
                    <h3>Top Referrers</h3>
                    <ol>
                    {% for a in referrals %}
                    <li><a href="http://{{ a.host }}">{{ a.host }}</a></li>
                    {% endfor %}
                    </ol>
                    <h3>Export Raw Stats</h3>
                    <p><a href="/mod/{{ mod.id }}/stats/downloads" class="btn btn-default btn-block">Export Downloads</a></p>
                    <p><a href="/mod/{{ mod.id }}/stats/followers" class="btn btn-default btn-block">Export Followers</a></p>
                    <p><a href="/mod/{{ mod.id }}/stats/referrals" class="btn btn-default btn-block">Export Referrals</a></p>
                    <p>Raw stats are from the beginning of time until now.
                    Each follower and download entry represents one hour of data.
                    Uneventful hours are omitted.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
